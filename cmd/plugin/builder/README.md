# Builder

Scaffolds and builds Tanzu plugin repositories

## Usage

### Init

`tanzu builder init <repo-name>` will initialize a new plugin repository with scaffolding for:

* Tanzu Framework CLI integration
* GolangCI linting config
* GitHub or GitLab CI config
* A Makefile

For more details, this command supports a `--dry-run` flag which will show everything created:

```sh
tanzu builder init <repo-name> --dry-run
```

### Add-plugin

`tanzu builder cli add-plugin <plugin-name>` adds a new plugin to your repository. The plugins command will live in the `./cmd/plugin/<plugin-name>` directory.

### Compile

`tanzu builder cli compile` will compile a repository and create the artifacts to be used with tanzu cli.

The artifact output directory structure will be created to match the expected layout. This will include some plugin
metadata used in the publishing and installation of plugins in a `manifest.yaml` file and a `plugin.yaml` file for
each included plugin.

Plugins will find that their `make build` command will suffice for most compile cases, but there are many flags at your disposal as well:

```txt
--artifacts string   path to output artifacts (default "artifacts")
--ldflags string     ldflags to set on build
--match string       match a plugin name to build, supports globbing (default "*")
--path string        path of the plugins directory (default "./cmd/cli/plugin")
--target string      only compile for a specific target, use 'local' to compile for host os (default "all")
--version string     version of the root cli (required)
```

### Build-plugins

`tanzu builder plugin build` can be used to build the plugins and create artifacts that can be used with tanzu cli.

The artifacts output directory structure will be different compared to what we have with `tanzu builder cli compile`
command in a way that the `tanzu builder plugin build` command will automatically group plugins based on the given os_arch
and `target`.
This command will also generate a plugin manifest file (`plugin_manifest.yaml`) that can be used in the publishing and
installation of plugins from the local directory with `tanzu plugin install --local`.

Below are the flags available with this command:

```txt
      --artifacts string      path to output artifacts directory (default "./artifacts")
  -h, --help                  help for build
      --ldflags string        ldflags to set on build
      --match string          match a plugin name to build, supports globbing (default "*")
      --os-arch stringArray   compile for specific os-arch, use 'local' for host os, use '<os>_<arch>' for specific (e.g. 'linux_amd64') (default [all])
      --path string           path of plugin directory (default "./cmd/plugin")
  -v, --version string        version of the plugins
```

Below are a few examples:

```shell
  # Build all plugins under the 'cmd/plugin' directory for the local host os and arch
  tanzu builder plugin build --path ./cmd/plugin --version v0.0.2 --os-arch local

  # Build all plugins under the 'cmd/plugin' directory for os-arch 'darwin_amd64', 'linux_amd64', 'windows_amd64'
  tanzu builder plugin build --path ./cmd/plugin --version v0.0.2 --os-arch darwin_amd64 --os-arch linux_amd64 --os-arch windows_amd64

  # Build only foo plugin under the 'cmd/plugin' directory for all supported os-arch
  tanzu builder plugin build --path ./cmd/plugin --version v0.0.2 --os-arch all --match foo
```

Here is the artifacts directory structure that gets generated by running the `tanzu builder plugin build --path ./cmd/plugin --version v0.0.2 --os-arch darwin_amd64 --os-arch linux_amd64` command. Assuming we have 2 plugins `foo` with a `global` target and `bar` with a `kubernetes` target available under `./cmd/plugin` directory.

```shell
artifacts
├── darwin
│   └── amd64
│       ├── global
│       │   └── foo
│       │       └── v0.0.2
│       │           └── tanzu-foo-darwin_amd64
│       ├── kubernetes
│       │   └── bar
│       │       └── v0.0.2
│       │           └── tanzu-bar-darwin_amd64
│       └── plugin_manifest.yaml
├── linux
│   └── amd64
│       ├── global
│       │   └── foo
│       │       └── v0.0.2
│       │           └── tanzu-foo-linux_amd64
│       ├── kubernetes
│       │   └── bar
│       │       └── v0.0.2
│       │           └── tanzu-bar-linux_amd64
│       └── plugin_manifest.yaml
└── plugin_manifest.yaml

```

Note: `tanzu builder plugin build` command expects plugin to met one of following two condition:

* Each plugin advertises the `Target` information as part of the PluginDescriptor.
* Each plugin directory contains a `metadata.yaml` file which describes the name and the target of the plugin.

### Publish

`tanzu builder publish` is used to publish the compiled plugin to a target output. The two supported targets for
publishing are "local" for the legacy local filesystem output, or "oci" for the recommended OCI image bundle.

Arguments to the `publish` command are:

```txt
--input-artifact-dir string                  artifact directory which is a output of 'tanzu builder cli compile' command
--local-output-discovery-dir string          local output directory where CLIPlugin resource yamls for discovery will be placed. Applicable to 'local' type
--local-output-distribution-dir string       local output directory where plugin binaries will be placed. Applicable to 'local' type
--oci-discovery-image string                 image path to publish oci image with CLIPlugin resource yamls. Applicable to 'oci' type
--oci-distribution-image-repository string   image path prefix to publish oci image for plugin binaries. Applicable to 'oci' type
--os-arch string                             list of os-arch (default "darwin-amd64 linux-amd64 windows-amd64")
--plugins string                             list of plugin names. Example: 'login management-cluster cluster'
--type string                                type of discovery and distribution for publishing plugins. Supported: local
--version string                             recommended version of the plugins
```
